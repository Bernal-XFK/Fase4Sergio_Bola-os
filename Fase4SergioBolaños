import tkinter as tk
from tkinter import messagebox
from datetime import datetime

# ----------------- FUNCIÓN PARA CENTRAR VENTANAS -----------------

def centrar_ventana(ventana, ancho, alto):
    ventana.update_idletasks()
    x = (ventana.winfo_screenwidth() // 2) - (ancho // 2)
    y = (ventana.winfo_screenheight() // 2) - (alto // 2)
    ventana.geometry(f"{ancho}x{alto}+{x}+{y}")

# ----------------- LÓGICA DEL ÁRBOL BINARIO DE BÚSQUEDA -----------------

class Nodo:
    def __init__(self, valor, nivel=1):
        self.valor = valor
        self.izq = None
        self.der = None
        self.nivel = nivel  # nivel del nodo (raíz = 1)

class ArbolBinarioBusqueda:
    def __init__(self, max_nivel=4):
        self.raiz = None
        self.max_nivel = max_nivel

    def insertar(self, valor):
        if self.raiz is None:
            self.raiz = Nodo(valor, nivel=1)
        else:
            self._insertar_rec(self.raiz, valor, nivel_actual=1)

    def _insertar_rec(self, nodo, valor, nivel_actual):
        if valor == nodo.valor:
            return

        siguiente_nivel = nivel_actual + 1
        if siguiente_nivel > self.max_nivel:
            raise ValueError(
                f"No se puede insertar: se excede el nivel máximo ({self.max_nivel})"
            )

        if valor < nodo.valor:
            if nodo.izq is None:
                nodo.izq = Nodo(valor, nivel=siguiente_nivel)
            else:
                self._insertar_rec(nodo.izq, valor, siguiente_nivel)
        else:
            if nodo.der is None:
                nodo.der = Nodo(valor, nivel=siguiente_nivel)
            else:
                self._insertar_rec(nodo.der, valor, siguiente_nivel)

    def buscar(self, valor):
        return self._buscar_rec(self.raiz, valor)

    def _buscar_rec(self, nodo, valor):
        if nodo is None:
            return None
        if valor == nodo.valor:
            return nodo
        if valor < nodo.valor:
            return self._buscar_rec(nodo.izq, valor)
        else:
            return self._buscar_rec(nodo.der, valor)

    def limpiar(self):
        self.raiz = None

    def preorden(self):
        resultado = []
        self._preorden_rec(self.raiz, resultado)
        return resultado

    def _preorden_rec(self, nodo, resultado):
        if nodo is not None:
            resultado.append(nodo.valor)
            self._preorden_rec(nodo.izq, resultado)
            self._preorden_rec(nodo.der, resultado)

    def inorden(self):
        resultado = []
        self._inorden_rec(self.raiz, resultado)
        return resultado

    def _inorden_rec(self, nodo, resultado):
        if nodo is not None:
            self._inorden_rec(nodo.izq, resultado)
            resultado.append(nodo.valor)
            self._inorden_rec(nodo.der, resultado)

    def posorden(self):
        resultado = []
        self._posorden_rec(self.raiz, resultado)
        return resultado

    def _posorden_rec(self, nodo, resultado):
        if nodo is not None:
            self._posorden_rec(nodo.izq, resultado)
            self._posorden_rec(nodo.der, resultado)
            resultado.append(nodo.valor)

# ----------------- VENTANA PRINCIPAL DEL ÁRBOL (GUI) -----------------

class VentanaArbol(tk.Toplevel):
    def __init__(self, master=None, nombre_estudiante=""):
        super().__init__(master)
        self.title("Árbol Binario de Búsqueda - Fase 4")
        centrar_ventana(self, 1000, 700)
        self.resizable(False, False)

        self.nombre_estudiante = nombre_estudiante

        self.arbol = ArbolBinarioBusqueda(max_nivel=4)
        self.valor_buscado = None

        self._crear_widgets()

    def _crear_widgets(self):
        frame_top = tk.Frame(self, padx=10, pady=10)
        frame_top.pack(side=tk.TOP, fill=tk.X)

        tk.Label(frame_top, text="Valor entero:").pack(side=tk.LEFT)

        self.entrada_valor = tk.Entry(frame_top, width=10)
        self.entrada_valor.pack(side=tk.LEFT, padx=5)

        btn_agregar = tk.Button(frame_top, text="Agregar Nodo",
                                command=self.agregar_nodo)
        btn_agregar.pack(side=tk.LEFT, padx=5)

        btn_buscar = tk.Button(frame_top, text="Buscar Nodo",
                               command=self.buscar_nodo)
        btn_buscar.pack(side=tk.LEFT, padx=5)

        btn_limpiar = tk.Button(frame_top, text="Limpiar",
                                command=self.limpiar_arbol)
        btn_limpiar.pack(side=tk.LEFT, padx=5)

        btn_salir = tk.Button(frame_top, text="Salir",
                              command=self.cerrar_aplicacion)
        btn_salir.pack(side=tk.RIGHT, padx=5)

        tk.Label(frame_top, text=f"Estudiante: {self.nombre_estudiante}").pack(
            side=tk.RIGHT, padx=20
        )

        frame_center = tk.Frame(self, padx=10, pady=10)
        frame_center.pack(side=tk.TOP, fill=tk.BOTH, expand=True)

        frame_arbol = tk.Frame(frame_center, bd=2, relief=tk.SUNKEN)
        frame_arbol.grid(row=0, column=0, padx=5, pady=5, sticky="nsew")
        tk.Label(frame_arbol, text="Árbol").pack()
        self.canvas_arbol = tk.Canvas(frame_arbol, width=480, height=300, bg="white")
        self.canvas_arbol.pack()

        frame_pre = tk.Frame(frame_center, bd=2, relief=tk.SUNKEN)
        frame_pre.grid(row=0, column=1, padx=5, pady=5, sticky="nsew")
        tk.Label(frame_pre, text="Preorden").pack()
        self.canvas_pre = tk.Canvas(frame_pre, width=480, height=140, bg="white")
        self.canvas_pre.pack()

        frame_in = tk.Frame(frame_center, bd=2, relief=tk.SUNKEN)
        frame_in.grid(row=1, column=0, padx=5, pady=5, sticky="nsew")
        tk.Label(frame_in, text="Inorden").pack()
        self.canvas_in = tk.Canvas(frame_in, width=480, height=140, bg="white")
        self.canvas_in.pack()

        frame_pos = tk.Frame(frame_center, bd=2, relief=tk.SUNKEN)
        frame_pos.grid(row=1, column=1, padx=5, pady=5, sticky="nsew")
        tk.Label(frame_pos, text="Posorden").pack()
        self.canvas_pos = tk.Canvas(frame_pos, width=480, height=140, bg="white")
        self.canvas_pos.pack()

        frame_center.rowconfigure(0, weight=1)
        frame_center.rowconfigure(1, weight=1)
        frame_center.columnconfigure(0, weight=1)
        frame_center.columnconfigure(1, weight=1)

    def leer_valor_entrada(self):
        texto = self.entrada_valor.get().strip()
        if texto == "":
            raise ValueError("Debe ingresar un valor.")
        try:
            return int(texto)
        except ValueError:
            raise ValueError("Debe ingresar un número entero.")

    def agregar_nodo(self):
        try:
            valor = self.leer_valor_entrada()
            self.arbol.insertar(valor)
            self.valor_buscado = None
            self.actualizar_graficos()
        except ValueError as e:
            messagebox.showerror("Error al agregar nodo", str(e))

    def buscar_nodo(self):
        try:
            valor = self.leer_valor_entrada()
            nodo = self.arbol.buscar(valor)
            if nodo is None:
                messagebox.showinfo(
                    "Resultado de la búsqueda",
                    f"El nodo con valor {valor} no existe en el árbol."
                )
                self.valor_buscado = None
            else:
                self.valor_buscado = valor
                messagebox.showinfo(
                    "Resultado de la búsqueda",
                    f"El nodo con valor {valor} SÍ se encuentra en el árbol."
                )
            self.actualizar_graficos()
        except ValueError as e:
            messagebox.showerror("Error en la búsqueda", str(e))

    def limpiar_arbol(self):
        self.arbol.limpiar()
        self.valor_buscado = None
        self.actualizar_graficos()

    def cerrar_aplicacion(self):
        self.destroy()
        if self.master is not None:
            self.master.destroy()

    def actualizar_graficos(self):
        self.dibujar_arbol()
        self.dibujar_recorrido(self.canvas_pre, self.arbol.preorden())
        self.dibujar_recorrido(self.canvas_in, self.arbol.inorden())
        self.dibujar_recorrido(self.canvas_pos, self.arbol.posorden())

    def dibujar_arbol(self):
        self.canvas_arbol.delete("all")
        if self.arbol.raiz is None:
            return

        ancho = int(self.canvas_arbol["width"])
        alto = int(self.canvas_arbol["height"])

        x_raiz = ancho // 2
        y_inicio = 40
        dx_inicial = ancho // 4
        dy = 60

        def dibujar_nodo(nodo, x, y, dx):
            if nodo is None:
                return

            if nodo.izq is not None:
                x_izq = x - dx
                y_izq = y + dy
                self.canvas_arbol.create_line(x, y, x_izq, y_izq)
                dibujar_nodo(nodo.izq, x_izq, y_izq, max(dx // 2, 20))
            if nodo.der is not None:
                x_der = x + dx
                y_der = y + dy
                self.canvas_arbol.create_line(x, y, x_der, y_der)
                dibujar_nodo(nodo.der, x_der, y_der, max(dx // 2, 20))

            radio = 15
            color_relleno = "lightblue"
            if self.valor_buscado is not None and nodo.valor == self.valor_buscado:
                color_relleno = "yellow"

            self.canvas_arbol.create_oval(
                x - radio, y - radio, x + radio, y + radio,
                fill=color_relleno, outline="black"
            )
            self.canvas_arbol.create_text(x, y, text=str(nodo.valor))

        dibujar_nodo(self.arbol.raiz, x_raiz, y_inicio, dx_inicial)

    def dibujar_recorrido(self, canvas, lista_valores):
        canvas.delete("all")
        if not lista_valores:
            return

        ancho = int(canvas["width"])
        alto = int(canvas["height"])

        n = len(lista_valores)
        margen = 30
        espacio = max((ancho - 2 * margen) // max(n, 1), 40)
        y = alto // 2
        radio = 12

        for i, valor in enumerate(lista_valores):
            x = margen + i * espacio
            canvas.create_oval(
                x - radio, y - radio, x + radio, y + radio,
                fill="lightgreen", outline="black"
            )
            canvas.create_text(x, y, text=str(valor))

# ----------------- VENTANA DE LOGIN -----------------

class VentanaLogin(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Fase4BolanosAcosta - Acceso")
        centrar_ventana(self, 400, 250)
        self.resizable(False, False)

        self._crear_widgets()

    def _crear_widgets(self):
        frame = tk.Frame(self, padx=20, pady=20)
        frame.pack(expand=True)

        tk.Label(
            frame, text="Aplicacion: Arboles Binarios", font=("Arial", 13, "bold")
        ).pack(pady=5)

        tk.Label(
            frame,
            text="Estudiante: Sergio Efren Bolaños Acosta"
        ).pack(pady=2)

        fecha_hoy = datetime.now().strftime("%d/%m/%Y")
        tk.Label(frame, text=f"Fecha: {fecha_hoy}").pack(pady=2)

        tk.Label(frame, text="Contraseña:").pack(pady=5)
        self.entry_pass = tk.Entry(frame, show="*", width=20)
        self.entry_pass.pack()

        btn_ingresar = tk.Button(
            frame, text="Ingresar", command=self.validar_contrasena
        )
        btn_ingresar.pack(pady=10)

    def validar_contrasena(self):
        password = self.entry_pass.get().strip()
        if password == "UNAD":
            self.withdraw()
            ventana_arbol = VentanaArbol(
                master=self, nombre_estudiante="Sergio Efren Bolaños Acosta"
            )
            ventana_arbol.protocol("WM_DELETE_WINDOW", ventana_arbol.cerrar_aplicacion)
        else:
            messagebox.showerror("Error de acceso", "Contraseña incorrecta. Intente nuevamente.")

# ----------------- PROGRAMA PRINCIPAL -----------------

if __name__ == "__main__":
    app = VentanaLogin()
    app.mainloop()
